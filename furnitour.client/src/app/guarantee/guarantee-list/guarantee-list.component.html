<div class="container mt-4">  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
      {{ isAdmin ? 'Адміністрування гарантій' : 'Мої гарантії' }}
      <span *ngIf="isAdmin && !loading" class="badge bg-secondary ms-2">{{ guarantees.length }}</span>
    </h1>
    <div>
      <button *ngIf="isAdmin && !loading && guarantees.length > 0" class="btn btn-success me-2" (click)="exportToCsv()">
        <i class="fas fa-file-export"></i> Експорт в CSV
      </button>
      <a *ngIf="!isAdmin" routerLink="/guarantees/create" class="btn btn-primary">Подати нову гарантію</a>
    </div>
  </div>

  <!-- Error alert -->
  <div *ngIf="error" class="alert alert-danger" role="alert">
    {{ error }}
  </div>

  <!-- Loading spinner -->
  <div *ngIf="loading" class="d-flex justify-content-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Завантаження...</span>
    </div>
  </div>  <!-- No guarantees message -->
  <div *ngIf="!loading && guarantees.length === 0" class="alert alert-info">
    Гарантій не знайдено. Створіть новий запит на гарантію.
  </div>
  
  <!-- Status filter info -->
  <div *ngIf="isAdmin && !loading && guarantees.length > 0 && statusFilter" class="alert alert-info">
    <strong>Фільтр активний:</strong> {{ statusFilter }} ({{ sortedGuarantees.length }} з {{ guarantees.length }} гарантій)
    <button class="btn btn-sm btn-outline-primary ms-3" (click)="filterByStatus('')">Скинути фільтр</button>
  </div>
  
  <!-- No filtered guarantees message -->
  <div *ngIf="!loading && guarantees.length > 0 && sortedGuarantees.length === 0" class="alert alert-warning">
    Немає гарантій, що відповідають обраному фільтру.
    <button class="btn btn-sm btn-outline-primary ms-3" (click)="filterByStatus('')">Скинути фільтр</button>
  </div>
  <!-- Admin statistics -->
  <div *ngIf="isAdmin && !loading && guarantees.length > 0" class="mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Статистика гарантій</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-8">
            <h6>Розподіл гарантій за статусами:</h6>
            <div class="d-flex flex-wrap gap-2 mb-3">
              <div *ngFor="let status of availableStatuses" class="badge" 
                  [ngClass]="getStatusClass(status)" 
                  style="font-size: 1rem; cursor: pointer;"
                  (click)="filterByStatus(status)">
                {{ status }}: {{ statusStats[status] || 0 }}
              </div>
            </div>
          </div>
          <div class="col-md-4 text-center">
            <h6>Загальна кількість:</h6>
            <div class="display-4">{{ guarantees.length }}</div>
            <p class="text-muted">гарантій в системі</p>
          </div>
        </div>
      </div>
    </div>
  </div>
    <!-- Admin controls -->
  <div *ngIf="isAdmin && !loading && guarantees.length > 0" class="mb-3">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Керування відображенням</h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <h6>Фільтрація за статусом:</h6>
          <div class="btn-group flex-wrap">
            <button type="button" class="btn" [ngClass]="{'btn-primary': statusFilter === '', 'btn-outline-primary': statusFilter !== ''}" (click)="filterByStatus('')">
              Всі статуси
            </button>
            <button *ngFor="let status of availableStatuses" type="button" class="btn" 
                [ngClass]="{'btn-primary': statusFilter === status, 'btn-outline-primary': statusFilter !== status}"
                (click)="filterByStatus(status)">
              {{ status }}
            </button>
          </div>
        </div>
        
        <div>
          <h6>Сортування:</h6>
          <div class="btn-group flex-wrap">
            <button type="button" class="btn" [ngClass]="{'btn-primary': sortField === 'dateCreated', 'btn-outline-primary': sortField !== 'dateCreated'}" (click)="sortGuarantees('dateCreated')">
              За датою створення {{ sortField === 'dateCreated' ? (sortDirection === 'asc' ? '↑' : '↓') : '' }}
            </button>
            <button type="button" class="btn" [ngClass]="{'btn-primary': sortField === 'status', 'btn-outline-primary': sortField !== 'status'}" (click)="sortGuarantees('status')">
              За статусом {{ sortField === 'status' ? (sortDirection === 'asc' ? '↑' : '↓') : '' }}
            </button>
            <button type="button" class="btn" [ngClass]="{'btn-primary': sortField === 'userName', 'btn-outline-primary': sortField !== 'userName'}" (click)="sortGuarantees('userName')">
              За користувачем {{ sortField === 'userName' ? (sortDirection === 'asc' ? '↑' : '↓') : '' }}
            </button>
            <button type="button" class="btn" [ngClass]="{'btn-primary': sortField === 'id', 'btn-outline-primary': sortField !== 'id'}" (click)="sortGuarantees('id')">
              За ID {{ sortField === 'id' ? (sortDirection === 'asc' ? '↑' : '↓') : '' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Guarantees list -->
  <div *ngIf="!loading && guarantees.length > 0" class="row row-cols-1 row-cols-md-2 g-4">
    <div *ngFor="let guarantee of sortedGuarantees" class="col">      <div class="card h-100">        <div class="card-header d-flex justify-content-between">
          <span>
            Замовлення #{{ guarantee.orderId }}
            <small *ngIf="isAdmin" class="text-muted">(ID: {{ guarantee.id }})</small>
          </span>
          <span [class]="getStatusClass(guarantee.status)">{{ guarantee.status }}</span>
        </div>
        <div class="card-body">
          <h5 class="card-title mb-3">Гарантія користувача {{ guarantee.userName }}</h5>
            <p class="mb-1"><strong>Товари:</strong></p>
          <ul class="list-group mb-3">
            <li *ngFor="let item of guarantee.items" class="list-group-item d-flex justify-content-between align-items-center">
              {{ item.furnitureName }}
              <span class="badge bg-primary rounded-pill">{{ item.quantity }}</span>
            </li>
          </ul>

          <p class="card-text"><strong>Коментар:</strong> {{ guarantee.comment }}</p>
          
          <p class="text-muted mb-0">
            <small>Створено: {{ guarantee.dateCreated | date:'medium' }}</small>
          </p>
          <p class="text-muted">
            <small>Оновлено: {{ guarantee.dateModified | date:'medium' }}</small>
          </p>
        </div>
        <div class="card-footer bg-transparent">
          <div class="d-flex justify-content-between">            <a [routerLink]="['/guarantees/', guarantee.id]" class="btn btn-sm btn-outline-primary">Деталі</a>
              <div *ngIf="isAdmin && guarantee.status === 'Очікує розгляду'" class="btn-group" role="group">
              <button class="btn btn-sm btn-success" (click)="updateStatus(guarantee, 'Підтверджено')">Підтвердити</button>
              <button class="btn btn-sm btn-warning" (click)="updateStatus(guarantee, 'На розгляді')">На розгляд</button>
              <button class="btn btn-sm btn-danger" (click)="updateStatus(guarantee, 'Відхилено')">Відхилити</button>
            </div>
            
            <div *ngIf="isAdmin && guarantee.status === 'На розгляді'" class="btn-group" role="group">
              <button class="btn btn-sm btn-success" (click)="updateStatus(guarantee, 'Підтверджено')">Підтвердити</button>
              <button class="btn btn-sm btn-danger" (click)="updateStatus(guarantee, 'Відхилено')">Відхилити</button>
            </div>
            
            <div *ngIf="isAdmin && guarantee.status === 'Підтверджено'" class="btn-group" role="group">
              <button class="btn btn-sm btn-info" (click)="updateStatus(guarantee, 'В обробці')">Почати обробку</button>
            </div>
            
            <div *ngIf="isAdmin && guarantee.status === 'В обробці'" class="btn-group" role="group">
              <button class="btn btn-sm btn-primary" (click)="updateStatus(guarantee, 'Завершено')">Завершити</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
